# 16 자바 메모리 모델
- 책 전체에 걸쳐 자바 메모리 모델(JMM) 부분 언급 자제하고 안전한 공개, 동기화 정책을 정하고 그 정책을 따르는 방법 등과 같이 중요한 상위 개념 위주로 설명
- 하지만 상위 개념이 제공하는 안전성은 모두 JMM 기반으로 하고 있고, JMM의 내부 구조가 어떻게 동작하는지를 이해하고 있다면 상위 개념 쉽게 사용 가능
- 16장에서는 JMM이 보장하는 기능과 요구사항, 그리고 이 책 전체에서 소개했던 내용이 실제로는 어떻게 동작하는지에 대한 원리를 알아본다.

## 16.1 JMM은 무엇이며, 왜 사용해야 하는가?
- 특정 스레드에서 aVariable 이라는 변수에 값을 할당한다고 해보자 
    - aVariable = 3;
- JMM은 "스레드가 aVariable에 할당된 3이란 값을 사용할 수 있으려면 어떤 조건이 돼야 하는가?" 에 대한 답을 알고 있다.
- 만약 동기화 기법을 사용하지 않는 상태의 경우 특정 스레드가 값이 할당되는 즉시, 심지어는 영원히 3이라는 값을 읽어가지 못하게 되는 여러 상황 발생 가능
- 컴파일러에서 소스코드에 적힌 내용을 명확하게 구현하는 코드를 생성해내지 못할 가능성도 있고, 변수의 값을 메모리에 저장하는 대신 CPU의 레지스터에 보관할 수도 있다.
- CPU 프로세서는 프로그램을 순차적으로 실행하거나 또는 병렬로 실행할 수도 있고, 사용하는 캐시의 형태에 따라서 할당된 값이 메모리에 실제 보관되는 시점에 차이가 있기도 하며, CPU 내부의 캐시에 보관된 할당 값이 다른 CPU의 시야에는 보이지 않을 수도 있다.
- 이런 원인 때문에 적절한 동기화 방법을 사용하지 않았다면, 특정 스레드에서 변수에 할당된 최신 값을 읽어가지 못할 수 있으며 따라서 다른 스레드의 시각으로 보기에 이상한 방법으로 실행될 가능성이 있다.
- 단일 스레드로 동작하는 환경에서는 프로그램이 동작하면서 사용했던 여러 가지 기법이 만들어낸 결과가 숨겨져 있고, 반면 그로 인해 전체적인 프로그램의 실행 속도는 상당히 빨라진다.
- 자바 언어 명세에서는 JVM이 단일 스레드 내부에서는 순차적으로 동작하는 것과 동일하게 실행되도록 명시되고 있다.
- 프로그램이 완벽하게 순차적으로 실행되는 환경과 동일한 순서로 실행된 것처럼 같은 결과를 만들어 내주기만 한다면 여러 가지 기법을 사용해도 문제가 없다.
- 실행속도를 높이는 여러 가지 기법은 처리 속도를 높이기 위한 최근의 노력에서 중요한 위치를 차지하고 있다. 물론 CPU의 클럭 스피드가 높아진 것도 프로그램 실행 속도를 높여 주었지만, 병렬 처리 방법 역시 프로그램의 실행속도를 크게 높여줬다.
    - ex : 파이프라인 슈퍼스칼라 실행 구조라든가 동적인 명령 스케쥴링, 모험적인 실행 방법, 섬세한 다중 메모리 캐싱 등
- 하드웨어 프로세서가 고급화됨에 따라 컴파일러 역시 최적의 실행 방법을 찾아내거나 전역 레지스터 할당 알고리즘과 같은 섬세한 기능을 갖추고 있다.
- 또한 클럭 스피드를 높이는 것만으론느 적절한 가격에 원하는 만큼 속도를 높이기가 어려워지면서, 프로세서 제조 업체에서는 멀티 코어 프로세서 구조로 이동하면서 하드웨어적인 병렬 작업을 통해 속도 향상을 꾀하고 있다.
- 멀티스레드로 실행되는 환경에서는 성능을 크게 제한하지 않는 한 순차성이 주는 안전성과 높은 성능을 찾아보기 어렵다.
- 병렬 프로그램이라 하더라도 대부분의 시간은 스레드 내부에서 '각자의 작업'을 처리하기 때문에 스레드 간의 작업 조율 기능에 자원을 많이 낭비하는 일은 별 이득도 없으면서 프로그램의 성능만 떨어뜨리는 결과를 낳는다.
- 스레드 간의 작업을 조율하는데 꼭 필요한 데이터만을 공유해 사용하는 것이 올바른 방법이고, JVM은 동기화 기능을 사용하는 부분에 한해서 프로그램에 스레드 간의 조율을 하고자 한다는 점을 파악할 수 있다.
- JMM은 변수의 저장된 값이 어느 시점부터 다른 스레드의 가시권에 들어가는지에 대해 JVM이 해야만 하는 최소한의 보장만 할 뿐이다.
- JMM은 예측성에 대한 필요와 함께 높은 성능의 JVM을 다양한 종류의 프로세서 구조에서 동작하도록 해야 한다는 실제적인 요구 사항을 쉽게 구현할 수 있어야 한다는 점의 균형을 맞출 목적으로 설계됐다.
- 특히 JMM의 일부는 JVM에서 실행되는 프로그램의 성능을 최대한 끌어낼 수 있도록 최신 프로세서와 컴파일러에서 사용하는 여러 기법을 사용하고 있는데, 이런 부분에 약간 어려움이 있을 수 있다.

### 16.1.1 플랫폼 메모리 모델
