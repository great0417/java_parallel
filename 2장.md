# 02. 스레드 안정성

- 스레드 안정성
    - 스레드 안정성이란 코드를 보호하기 위함이 아니라 데이터에 제어 없이 동시 접근하는걸 막으려는데에 있다.
    - 동기화의 종류 - synchronized, volatile 변수, 명시적 락, 단일 연산 변수
    - 적절한 동기화 없이 접근하는 잘못된 프로그램을 고치는 방법
    > - 해당 상태 변수를 스레드 간에 공유하지 않기
    > -  해당 상태 변수를 변경할 수 없도록 만들기
    > - 해당 상태 변수에 접근할 때는 언제나 동기화를 사용하기  
    - 스레드 안전한 클래스를 설계할 땐, 바람직한 객체 지향 기법(캡슐화, 불변객체 활용, 불변조건 명확하게 기술) 사용    

- 2.1 스레드 안정성이란?
    - 스레드 정의의 핵심은 정확성개념과 관계가 있다.
        - 정확성이란 클래스가 해당 클래스에 명세에 부합.
        > - 여러 스레드가 클래스에 접근 할때 호출하는 쪽에서 추갖거인 동기화나 다른 조율 없이도 정확하게 동작하면 해당 클래스는 스레드 안전
        > - 스레드 안전한 클래스는 클라이언트 쪽에서 별도로 동기화할 필요가 없도록 동기화 기능도 캡슐화.
    - 상태없는 서블릿 
        - 선언한 변수가 없고, 다른 클래스의 변수를 참조하지 않는 상태가 없는 서블릿의 경우 다른스레드들의 결과에 영향을 줄 수 없으므로 스레드 안전.                                                                  
- 2.2 단일 연산
    
     ![unsafe](/image/unsafecounting.PNG)
    
    - 동기화돼 있지 않다면 운이 나쁠 경우 양쪽 스레드가 같은 값을 읽을 경우가 생김.
    - 2.2.1 경쟁조건
        - 원하는 결과를 얻을 수 있을지의 여부는 여러 가지 사건의 상대적인 시점에 따라 달라짐.
        - 대부분 경쟁 조건은 이런 관찰 결과를 무효화로 특징 지어진다.
    - 2.2.2 예제 늦은 초기화 시 경쟁 조건 
        - ![lazyInit](/image/lazyInit.PNG)
        - 경쟁조건 발생시 저장된 내용을 잃거나 일관성이 없어짐.
    - 2.2.3 복합 동작
        - 변수가 수정되는 동안 다른 스레드가 해당 변수를 사용하지 못하도록 막아야 함
        - AtomicLong같은 스레드에 안전하게 만들어져있는 객체를 사용하는 편이 좋음.
- 2.3 락
    - AtomicLong과 비슷한 AtomicReference 클래스를 사용하더라도, 여러개의 AtomicReference클래스 사용 시 동시갱신이 되지 않는다면 불변 조건이 개질 수 있다. 
    - 2.3.1 암묵적인 락
        - 락은 synchronized 블록에 들어가기전 자동으로 확보되며, 그 블록이나 메소드에 들어가야만 암묵적인 락을 확보
        - synchronized로 두개 이상의 변수 사용시에도 안정성 확보 가능
    - 2.3.2 재진입성
        - 암묵적인 락은 재진입이 가능. 때문에 락의 동작을 캡슐화도 가능하고, 객체지향 병렬프로그램 개발이 단순해짐. 
- 2.4 락으로 상태 보호하기
    - 락으로 보호돼 있다는 사실은 @GuardedBy 어노테이션으로 표시
    - 여러 스레드가 동시에 접근하는 상태에서 전부 동기화할 경우 활동성이나 성능에 문제가 생기므로 변경 가능한 데이터를 여러스레드에서 접근해 사용하는 경우에만 내부 변수를 동기화해 보호해야 한다.
- 2.5 활동성과 성능
    - synchronized 블록의 범위를 줄여야 안정성을 줄이고 동시성을 향상시킬 수 있다. 다만 단일 연산으로 처리해야 하는 작업을 여러개의 synchronized블록으로 나누진 말아야 한다.
    - ![synchronized](/image/synchronized.PNG)
    - 인수분해와 같은 오래 걸리나 자원 공유에 영향을 안받는 작업은 락을 놓고, 상태변수 4개의 자원을 사용하는 경우에만 synchronized를 사용한다. 
    - 단순성과 성능이 상충할 경우가 있으므로, 성능을 위해 조급하게 단순성을 희생하고픈 유혹을 버려야 한다.
    - 복잡한 작업의 경우네는 가능한 락을 걸지 말아야 한다.                    